{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Pengaturan Preferensi Jadwal</h2>
    
    <form method="POST" id="preferencesForm">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Hari Mengajar yang Tersedia</h5>
            </div>
            <div class="card-body">
                {% for day in weekdays %}
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" name="available_days" value="{{ day }}"
                           id="day_{{ day }}" {% if day in preferences.available_days %}checked{% endif %}>
                    <label class="form-check-label" for="day_{{ day }}">{{ day }}</label>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>Waktu Preferensi per Hari</h5>
            </div>
            <div class="card-body">
                {% for day in weekdays %}
                <div class="day-preferences mb-3" id="prefs_{{ day }}">
                    <h6>{{ day }}</h6>
                    <div class="time-slots">
                        {% for pref in preferences.preferred_times.get(day, []) %}
                        <div class="row mb-2">
                            <div class="col">
                                <select name="preferred_times_{{ day }}_start" class="form-select">
                                    {% for time in time_slots %}
                                    <option value="{{ time }}" {% if time == pref.split('-')[0] %}selected{% endif %}>
                                        {{ time }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col">
                                <select name="preferred_times_{{ day }}_end" class="form-select">
                                    {% for time in time_slots %}
                                    <option value="{{ time }}" {% if time == pref.split('-')[1] %}selected{% endif %}>
                                        {{ time }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-auto">
                                <button type="button" class="btn btn-danger btn-sm remove-time">Hapus</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm mt-2 add-time" data-day="{{ day }}">
                        Tambah Waktu
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>Blok Waktu Tidak Tersedia</h5>
                <small class="text-muted">Jam-jam tertentu saat Anda tidak bisa mengajar (berlaku permanen)</small>
            </div>
            <div class="card-body">
                <div id="timeBlocksContainer">
                    {% for block in preferences.get('unavailable_time_ranges', []) %}
                    <div class="row mb-3 time-block-row">
                        <div class="col-md-3">
                            <label class="text-sm">Hari</label>
                            <select name="block_day[]" class="form-control form-control-sm">
                                <option value="*" {% if block.day == '*' %}selected{% endif %}>Semua Hari</option>
                                <option value="Senin" {% if block.day == 'Senin' %}selected{% endif %}>Senin</option>
                                <option value="Selasa" {% if block.day == 'Selasa' %}selected{% endif %}>Selasa</option>
                                <option value="Rabu" {% if block.day == 'Rabu' %}selected{% endif %}>Rabu</option>
                                <option value="Kamis" {% if block.day == 'Kamis' %}selected{% endif %}>Kamis</option>
                                <option value="Jumat" {% if block.day == 'Jumat' %}selected{% endif %}>Jumat</option>
                                <option value="Sabtu" {% if block.day == 'Sabtu' %}selected{% endif %}>Sabtu</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="text-sm">Jam Mulai</label>
                            <input type="time" name="block_start[]" class="form-control form-control-sm" value="{{ block.start }}">
                        </div>
                        <div class="col-md-3">
                            <label class="text-sm">Jam Selesai</label>
                            <input type="time" name="block_end[]" class="form-control form-control-sm" value="{{ block.end }}">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" class="btn btn-danger btn-sm remove-block">üóëÔ∏è Hapus</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-secondary btn-sm" id="addBlockBtn">‚ûï Tambah Blok Waktu</button>
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Contoh:</strong> Jika tidak bisa Senin‚ÄìJumat jam 08:00‚Äì10:00, tambahkan blok dengan "Semua Hari" atau satu per satu.
                    </small>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>Beban Mengajar Maksimum</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="max_load">Maksimum SKS:</label>
                    <input type="number" class="form-control" id="max_load" name="max_load"
                           value="{{ preferences.max_load }}" min="0" max="36">
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Simpan Preferensi</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tampilkan/sembunyikan preferensi waktu berdasarkan checkbox hari
    document.querySelectorAll('input[name="available_days"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const day = this.value;
            const prefDiv = document.getElementById('prefs_' + day);
            prefDiv.style.display = this.checked ? 'block' : 'none';
        });
        
        // Set initial visibility
        const day = checkbox.value;
        const prefDiv = document.getElementById('prefs_' + day);
        prefDiv.style.display = checkbox.checked ? 'block' : 'none';
    });

    // Handle tambah waktu
    document.querySelectorAll('.add-time').forEach(btn => {
        btn.addEventListener('click', function() {
            const day = this.dataset.day;
            const container = this.previousElementSibling;
            
            const timeSlotHtml = `
                <div class="row mb-2">
                    <div class="col">
                        <select name="preferred_times_${day}_start" class="form-select">
                            {% for time in time_slots %}
                            <option value="{{ time }}">{{ time }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col">
                        <select name="preferred_times_${day}_end" class="form-select">
                            {% for time in time_slots %}
                            <option value="{{ time }}">{{ time }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-danger btn-sm remove-time">Hapus</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', timeSlotHtml);
        });
    });

    // Handle hapus waktu
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-time')) {
            e.target.closest('.row').remove();
        }
    });

    // Handle tambah blok waktu tidak tersedia
    document.getElementById('addBlockBtn').addEventListener('click', function() {
        const container = document.getElementById('timeBlocksContainer');
        const blockHtml = `
            <div class="row mb-3 time-block-row">
                <div class="col-md-3">
                    <label class="text-sm">Hari</label>
                    <select name="block_day[]" class="form-control form-control-sm">
                        <option value="*">Semua Hari</option>
                        <option value="Senin">Senin</option>
                        <option value="Selasa">Selasa</option>
                        <option value="Rabu">Rabu</option>
                        <option value="Kamis">Kamis</option>
                        <option value="Jumat">Jumat</option>
                        <option value="Sabtu">Sabtu</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="text-sm">Jam Mulai</label>
                    <input type="time" name="block_start[]" class="form-control form-control-sm" value="08:00">
                </div>
                <div class="col-md-3">
                    <label class="text-sm">Jam Selesai</label>
                    <input type="time" name="block_end[]" class="form-control form-control-sm" value="10:00">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm remove-block">üóëÔ∏è Hapus</button>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', blockHtml);
    });

    // Handle hapus blok
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-block')) {
            e.target.closest('.time-block-row').remove();
        }
    });
});
</script>
{% endblock %}